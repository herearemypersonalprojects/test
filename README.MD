
# Lozu Heritage Map â€” Architecture & Installation Guide

> **Version:** 1.0
> **Components:** Frontend (Web + Mobile React), Backend API (FastAPI on Cloud Run), Google Cloud Storage
> **Author:** Team Lozu
> **Purpose:** Ná»n táº£ng báº£n Ä‘á»“ di sáº£n / POIs / heritage vá»›i dá»¯ liá»‡u subset public + full protected dataset.

---

# ğŸ“Œ 1. Tá»•ng quan kiáº¿n trÃºc

Há»‡ thá»‘ng gá»“m 3 pháº§n:

```
/web-frontend      â†’ React (Web)
/mobile-frontend   â†’ React (Mobile)
/backend           â†’ Python FastAPI (JWT Auth + GCS Signed URL)
```

File dá»¯ liá»‡u:

* `paris_public.json`  â†’ Public, dung lÆ°á»£ng nhá»
* `paris_full.json`    â†’ Full 60MB, chá»‰ ngÆ°á»i login má»›i táº£i Ä‘Æ°á»£c

LÆ°u Ã½ quan trá»ng:

* Full dataset **khÃ´ng bao giá» lÆ°u vÃ o localStorage / IndexedDB**.
* Chá»‰ táº£i *má»™t láº§n vÃ o RAM* sau login â†’ Ä‘Ã³ng tab lÃ  máº¥t â†’ tÄƒng báº£o máº­t, giáº£m rá»§i ro copy.

---

# ğŸ“Œ 2. SÆ¡ Ä‘á»“ kiáº¿n trÃºc

```mermaid
flowchart LR
    subgraph Client[Client Browser]
        UI[React Web/Mobile + MapLibre]
        Mem[Full dataset in RAM]
    end

    subgraph Cloud[GCP]
        Backend[Cloud Run FastAPI]
        GCS[(Google Cloud Storage\nparis_public.json\nparis_full.json)]
        Auth[Custom / Firebase / Identity Platform]
    end

    UI -->|GET /api/public-pois| Backend
    Backend -->|read| GCS

    UI -->|POST /auth/login| Backend
    Backend --> Auth
    Backend -->|JWT| UI

    UI -->|GET /api/full-url (JWT)| Backend
    Backend -->|Signed URL| GCS
    Backend --> UI

    UI -->|Download 60MB file| GCS
    UI -->|Store in RAM| Mem
```

---

# ğŸ“Œ 3. Backend (FastAPI) â€” `/backend`

## 3.1. Chá»©c nÄƒng chÃ­nh

* `/auth/login` â†’ Sinh JWT
* `/auth/me` â†’ Verify token
* `/api/public-pois` â†’ Tráº£ subset
* `/api/full-url` â†’ Verify JWT + tráº£ GCS Signed URL 5â€“15 phÃºt

## 3.2. Cáº¥u trÃºc thÆ° má»¥c

```
backend/
â”‚â”€â”€ main.py
â”‚â”€â”€ auth.py
â”‚â”€â”€ gcs.py
â”‚â”€â”€ requirements.txt
â”‚â”€â”€ Dockerfile
â””â”€â”€ .env.example
```

## 3.3. CÃ i Ä‘áº·t local

```bash
cd backend
pip install -r requirements.txt
uvicorn main:app --reload --port 8000
```

API cháº¡y táº¡i:

```
http://localhost:8000
```

## 3.4. Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng `.env`

```
JWT_SECRET=supersecretkey
JWT_EXPIRE_MINUTES=60

GCP_BUCKET_NAME=lozu-poi-bucket
GOOGLE_APPLICATION_CREDENTIALS=/app/service-account.json
```

## 3.5. Deploy backend lÃªn Cloud Run

```bash
gcloud builds submit --tag gcr.io/PROJECT_ID/lozu-backend
gcloud run deploy lozu-backend \
  --image gcr.io/PROJECT_ID/lozu-backend \
  --allow-unauthenticated \
  --platform managed \
  --region europe-west1
```

Sau khi deploy, phá»¥c vá»¥ táº¡i:

```
https://lozu-backend-xxxxxx.a.run.app
```

---

# ğŸ“Œ 4. Frontend Web â€” `/web-frontend`

## 4.1. CÃ´ng nghá»‡

* React + Vite
* MapLibre GL JS
* Sá»­ dá»¥ng API backend Ä‘á»ƒ táº£i dá»¯ liá»‡u

## 4.2. Cáº¥u trÃºc thÆ° má»¥c

```
web-frontend/
â”‚â”€â”€ src/
â”‚     â”œâ”€â”€ App.jsx
â”‚     â”œâ”€â”€ components/
â”‚     â”œâ”€â”€ hooks/
â”‚     â””â”€â”€ lib/
â”‚â”€â”€ public/
â”‚â”€â”€ index.html
â”‚â”€â”€ vite.config.js
â”‚â”€â”€ package.json
â””â”€â”€ README.md
```

## 4.3. Biáº¿n mÃ´i trÆ°á»ng

Táº¡o file `.env`:

```
VITE_API_BASE_URL=https://lozu-backend-xxxxxx.a.run.app
```

## 4.4. Cháº¡y local

```bash
cd web-frontend
npm install
npm run dev
```

## 4.5. Build production

```bash
npm run build
npm run preview
```

ThÆ° má»¥c build:

```
web-frontend/dist/
```

## 4.6. Deploy lÃªn GitHub Pages

CÃ¡ch 1 â€” Manual:

* Build â†’ Copy folder `dist/` â†’ push vÃ o branch `gh-pages`

CÃ¡ch 2 â€” GitHub Actions (khuyÃªn dÃ¹ng):

`.github/workflows/deploy.yml`

```yml
name: Deploy Web

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: npm install
        working-directory: web-frontend

      - run: npm run build
        working-directory: web-frontend

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: web-frontend/dist
```

---

# ğŸ“Œ 5. Frontend Mobile â€” `/mobile-frontend`

> LÃ  version UI dÃ nh riÃªng cho layout mobile, nhÆ°ng váº«n dÃ¹ng React + Vite (khÃ´ng cáº§n React Native).

Cáº¥u trÃºc tÆ°Æ¡ng tá»± web:

```
mobile-frontend/
â”‚â”€â”€ src/
â”‚â”€â”€ public/
â”‚â”€â”€ package.json
â”‚â”€â”€ vite.config.js
â””â”€â”€ ...
```

Build & deploy giá»‘ng há»‡t pháº§n web.

Báº¡n cÃ³ thá»ƒ deploy mobile vÃ o thÆ° má»¥c:

```
https://username.github.io/lozu/mobile/
```

vÃ  web:

```
https://username.github.io/lozu/web/
```

---

# ğŸ“Œ 6. CÃ¡ch frontend táº£i dá»¯ liá»‡u vÃ o RAM (báº£o máº­t content)

## 6.1. Load subset (public)

```js
const res = await fetch(`${API_BASE}/api/public-pois`);
publicPois = await res.json();
```

## 6.2. Login â†’ láº¥y JWT

```js
const res = await fetch(`${API}/auth/login`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ username, password })
});

const { access_token } = await res.json();
setToken(access_token);          // lÆ°u RAM
```

## 6.3. Láº¥y Signed URL â†’ táº£i full data

```js
let fullDataMemory = null; // RAM-only

export async function loadFullData(token) {
  if (fullDataMemory) return fullDataMemory;

  const sUrlRes = await fetch(`${API}/api/full-url`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const { downloadUrl } = await sUrlRes.json();

  const fileRes = await fetch(downloadUrl);
  const json = await fileRes.json();

  fullDataMemory = json.map((p, i) => ({ ...p, _idx: i }));
  return fullDataMemory;
}
```

## 6.4. KhÃ´ng lÆ°u localStorage

```js
// âŒ KhÃ´ng Ä‘Æ°á»£c lÃ m
localStorage.setItem("fullData", JSON.stringify(json));

// âœ” Chá»‰ lÆ°u RAM
state.fullPois = json;
```

---

# ğŸ“Œ 7. Báº£o máº­t

* Signed URL sá»‘ng tá»‘i Ä‘a **10 phÃºt**
* JWT háº¿t háº¡n **60 phÃºt**
* KhÃ´ng lÆ°u full data xuá»‘ng disk phÃ­a client
* KhÃ´ng cho phÃ©p export full dataset qua API public
* Náº¿u cáº§n: káº¿t há»£p Cloud Armor Ä‘á»ƒ rate limit

---

# ğŸ“Œ 8. Deployment Flow chuáº©n

```
[Dev Local]
   â†“
Git Push â†’ GitHub
   â†“
GitHub Actions build
   â†“
Deploy web-frontend to gh-pages
Deploy mobile-frontend to gh-pages
Deploy backend to Cloud Run
   â†“
User access: /web/ or /mobile/
```

---

# ğŸ“Œ 9. Checklist trÆ°á»›c khi cháº¡y Production

### Backend

* [ ] Service account cÃ³ `storage.objectViewer`
* [ ] Bucket private 100%
* [ ] JWT secret lÆ°u trong Secret Manager
* [ ] CORS chá»‰ cho domain frontend
* [ ] Signed URL expire < 15 phÃºt

### Frontend

* [ ] KhÃ´ng lÆ°u full data vÃ o localStorage / IndexedDB
* [ ] API_BASE chÃ­nh xÃ¡c
* [ ] MapLibre key (náº¿u cáº§n)
* [ ] Web + Mobile deploy thÃ nh 2 thÆ° má»¥c Ä‘á»™c láº­p

### Monitoring

* [ ] Log sá»‘ lÆ°á»£ng gá»i `/api/full-url`
* [ ] Log táº£i xuá»‘ng Signed URL (GCS usage)
* [ ] Error rate tá»« Cloud Run

---

# ğŸ“Œ 10. LiÃªn há»‡

* **Team Lozu Engineering**
* Email: `support@lozu.fr`
* GitHub: [https://github.com/lozu](https://github.com/lozu)
* Issue tracker: GitHub Issues

---
